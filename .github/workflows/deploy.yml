name: Deploy Blazor WASM to GitHub Pages

on:
  push:
    branches: [ "main" ] # Or "master", depending on your main branch
  workflow_dispatch:

  # THE PERMISSIONS BLOCK MUST BE INSERTED HERE
permissions:
  contents: write # CRITICAL: Allows the workflow to write to repository contents (including gh-pages).

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x' # Adjust this to your .NET version

    - name: Restore dependencies
      run: dotnet restore
      
    # The critical build step: Publish the app
    - name: Publish Blazor WebAssembly (Release Build)
      # NEW, CORRECTED LINE: Add path to .csproj file!
      # Creates the static assets in the folder 'app/publish/wwwroot'
      run: dotnet publish BlazorWebAssemblyApp/WebApp/WebApp.csproj -c Release -o app/publish --nologo
      # If your project is in the root of the repo, the path is:
      # run: dotnet publish BlazorWebAssemblyApp.csproj -c Release -o app/publish --nologo
      # --nologo is only cosmetic. More important is the configuration of the project file if you want to set the base path during build instead of in index.html.
      
    # When users access the application directly after deployment (https://chstorb.github.io/) it works, but with a deep link
    # or after a refresh on a subpage (e.g. /radzengrid) they get a 404 Not Found error. GitHub Pages is a static
    # host and does not know how to handle Blazor routing. The solution is to copy index.html to 404.html.
    # GitHub Pages uses 404.html as a fallback for not found routes, allowing Blazor to take over routing.
    - name: Fix 404 Routing for GitHub Pages
      run: cp app/publish/wwwroot/index.html app/publish/wwwroot/404.html

    - name: Create .nojekyll file
      run: touch app/publish/wwwroot/.nojekyll

    #- name: Adjust output directory for gh-pages
    #  # The static files are in the 'wwwroot' of the 'publish' folder.
    #  run: mv app/publish/wwwroot app/publish/dist
      
    # Deployment to GitHub Pages (peaceiris/actions-gh-pages is the standard)
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        #publish_dir: app/publish/dist # The directory containing the static files
        publish_dir: app/publish/wwwroot
        publish_branch: gh-pages # The branch read by GitHub Pages
        cname: chstorb.github.io # Optional, if you have a custom domain, otherwise remove
<!-- Mermaid.js Support -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@11.4.1/dist/mermaid.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log("Mermaid.js script loaded, initializing...");

        mermaid.initialize({
            startOnLoad: false,
            theme: 'dark',
            securityLevel: 'loose',
            logLevel: 'debug',
            sequence: {
                showSequenceNumbers: true,
                useMaxWidth: false,
                stickyFont: true
            }
        });

        // Find all potential Mermaid blocks
        // Jekyll/Rouge usually produces <div class="language-mermaid highlighter-rouge">...</div>
        // or <pre><code class="language-mermaid">...</code></pre>
        let mermaidBlocks = document.querySelectorAll('div.language-mermaid, pre.mermaid, code.language-mermaid');

        // If we still find nothing, let's look for anything that contains "mermaid" in the class
        if (mermaidBlocks.length === 0) {
            mermaidBlocks = document.querySelectorAll('[class*="mermaid"]');
        }

        console.log("Found " + mermaidBlocks.length + " potential mermaid blocks");

        if (mermaidBlocks.length > 0) {
            mermaidBlocks.forEach((el, index) => {
                // We need to find the container that holds the raw code
                let code = "";
                let targetEl = el;

                if (el.tagName === 'CODE' || el.tagName === 'PRE') {
                    code = el.innerText.trim();
                    // If it's a code tag, we want to replace its parent pre or the div wrapper
                    targetEl = el.closest('div.highlighter-rouge') || el.closest('pre') || el;
                } else {
                    const codeEl = el.querySelector('code');
                    code = codeEl ? codeEl.innerText.trim() : el.innerText.trim();
                }

                console.log("Processing block " + index + ", tag: " + el.tagName + ", classes: " + el.className);

                // Create a new container for Mermaid
                const mermaidDiv = document.createElement('pre');
                mermaidDiv.className = 'mermaid';
                mermaidDiv.textContent = code;

                const container = document.createElement('div');
                container.className = 'mermaid-container';
                container.appendChild(mermaidDiv);

                // Replace target element
                targetEl.parentNode.replaceChild(container, targetEl);
            });

            console.log("Running mermaid.run()...");
            mermaid.run().then(() => {
                console.log("Mermaid rendering complete.");
            }).catch(err => {
                console.error("Mermaid rendering failed:", err);
            });
        } else {
            // Log all code blocks to see what we are missing
            const allCode = document.querySelectorAll('pre, code');
            console.log("No mermaid blocks found. Total code/pre elements on page: " + allCode.length);
            allCode.forEach((c, i) => {
                if (i < 5) console.log("Code block " + i + " classes: ", c.className);
            });
        }
    });
</script>

<style>
    .mermaid-container {
        display: flex;
        justify-content: center;
        padding: 1.5rem 0;
        margin: 1.5rem 0;
        background: transparent !important;
    }

    .mermaid {
        background: transparent !important;
        color: inherit;
        font-family: inherit;
    }

    /* Ensure SVG is visible and centered */
    .mermaid svg {
        max-width: 100% !important;
        height: auto !important;
    }
</style>